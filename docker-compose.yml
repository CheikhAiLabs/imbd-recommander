# ==============================================================================
# IMDb Recommender System — Docker Compose
# ==============================================================================
# Full production stack: API, UI, MLflow, Prometheus, Grafana
#
# Ports (chosen to avoid conflicts):
#   API       → 9876
#   UI        → 9877
#   MLflow    → 9878
#   Prometheus→ 9879
#   Grafana   → 9880
#
# Usage:
#   docker compose up -d          # Start everything
#   docker compose logs -f api    # Follow API logs
#   docker compose down           # Stop everything
# ==============================================================================

services:
  # ── FastAPI Recommendation API ─────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: imdb-api
    ports:
      - "9876:8000"
    volumes:
      - ./data:/app/data
      - ./configs:/app/configs
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MLFLOW_EXPERIMENT_NAME=imdb-recommender
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    depends_on:
      mlflow:
        condition: service_healthy
    networks:
      - recommender-net

  # ── Streamlit UI ───────────────────────────────────────────────────────────
  ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: imdb-ui
    command: >
      streamlit run ui/app.py
      --server.port=8501
      --server.address=0.0.0.0
      --server.headless=true
      --browser.gatherUsageStats=false
    ports:
      - "9877:8501"
    environment:
      - API_BASE_URL=http://api:8000
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - recommender-net

  # ── MLflow Tracking Server ─────────────────────────────────────────────────
  mlflow:
    image: ghcr.io/mlflow/mlflow:v3.10.0
    container_name: imdb-mlflow
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri sqlite:///mlflow/mlflow.db
      --artifacts-destination /mlflow/artifacts
    ports:
      - "9878:5000"
    volumes:
      - mlflow-data:/mlflow
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
      - recommender-net

  # ── Prometheus ─────────────────────────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v3.2.1
    container_name: imdb-prometheus
    ports:
      - "9879:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    networks:
      - recommender-net

  # ── Grafana ────────────────────────────────────────────────────────────────
  grafana:
    image: grafana/grafana:11.5.2
    container_name: imdb-grafana
    ports:
      - "9880:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=recommender
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/recommender-overview.json
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - recommender-net

# ── Volumes ──────────────────────────────────────────────────────────────────
volumes:
  mlflow-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

# ── Networks ─────────────────────────────────────────────────────────────────
networks:
  recommender-net:
    driver: bridge
